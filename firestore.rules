rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(uid) {
      return isAuthenticated() && request.auth.uid == uid;
    }

    // USERS
    match /users/{uid} {
      allow read: if isAuthenticated();
      allow create: if isOwner(uid)
        && request.resource.data.keys().hasAll(['uid', 'id', 'email', 'createdAt', 'isActive'])
        && request.resource.data.uid == request.auth.uid
        && request.resource.data.id == uid;
      allow update: if isOwner(uid)
        && request.resource.data.uid == resource.data.uid
        && request.resource.data.id == resource.data.id
        && request.resource.data.createdAt == resource.data.createdAt;
      allow delete: if false;

      match /profile/{document} {
        allow read: if isAuthenticated() && isOwner(uid);
        allow write: if isOwner(uid);
        allow delete: if false;
      }

      match /questionnaire/{questionId} {
        allow read: if isOwner(uid);
        allow create: if isOwner(uid);
        allow update: if isOwner(uid);
        allow delete: if false;
      }

      match /kids/{kidId} {
        allow read: if isOwner(uid);
        allow write: if isOwner(uid);
        allow delete: if isOwner(uid);
      }

      match /availability/{document} {
        allow read: if isAuthenticated();
        allow write: if isOwner(uid);
        allow delete: if isOwner(uid);
      }

      match /shiftHistory/{shiftId} {
        allow read: if isOwner(uid);
        allow write: if false;
        allow delete: if false;
      }

      match /settings/{document} {
        allow read: if isOwner(uid);
        allow write: if isOwner(uid);
        allow delete: if false;
      }
    }

    // SWIPES (CURRENT APP SHAPE: /swipes/{swiperId_swipedId})
    match /swipes/{swipeId} {
      allow read: if isAuthenticated()
        && (resource.data.swiperId == request.auth.uid || resource.data.swipedId == request.auth.uid);
      allow create: if isAuthenticated()
        && request.resource.data.keys().hasAll(['swiperId', 'swipedId', 'direction', 'timestamp'])
        && request.resource.data.swiperId == request.auth.uid
        && request.resource.data.swiperId != request.resource.data.swipedId
        && request.resource.data.direction in ['left', 'right'];
      allow update: if isAuthenticated()
        && resource.data.swiperId == request.auth.uid
        && request.resource.data.keys().hasAll(['swiperId', 'swipedId', 'direction', 'timestamp'])
        && request.resource.data.swiperId == resource.data.swiperId
        && request.resource.data.swipedId == resource.data.swipedId
        && request.resource.data.swiperId == request.auth.uid
        && request.resource.data.direction in ['left', 'right'];
      allow delete: if isAuthenticated() && resource.data.swiperId == request.auth.uid;
    }

    // LEGACY SWIPES (FOR EXISTING FUNCTIONS, IF USED)
    match /swipes/{uid}/decisions/{targetUid} {
      allow read: if isOwner(uid);
      allow create: if isOwner(uid)
        && request.resource.data.keys().hasAll(['action', 'timestamp'])
        && request.resource.data.action in ['like', 'dislike', 'superlike'];
      allow update: if false;
      allow delete: if false;
    }

    // MATCHES (USED BY CLOUD FUNCTIONS FLOW)
    match /matches/{matchId} {
      allow read: if isAuthenticated()
        && (request.auth.uid == resource.data.uid1 || request.auth.uid == resource.data.uid2);
      allow create: if false;
      allow update: if isAuthenticated()
        && (request.auth.uid == resource.data.uid1 || request.auth.uid == resource.data.uid2)
        && request.resource.data.uid1 == resource.data.uid1
        && request.resource.data.uid2 == resource.data.uid2;
      allow delete: if false;
    }

    // CHATS (USED BY CLOUD FUNCTIONS FLOW)
    match /chats/{matchId} {
      allow read: if isAuthenticated()
        && request.auth.uid in resource.data.participants;
      allow create: if false;
      allow update: if isAuthenticated()
        && request.auth.uid in resource.data.participants;
      allow delete: if false;

      match /messages/{messageId} {
        allow read: if isAuthenticated()
          && request.auth.uid in get(/databases/$(database)/documents/chats/$(matchId)).data.participants;
        allow create: if isAuthenticated()
          && request.auth.uid in get(/databases/$(database)/documents/chats/$(matchId)).data.participants
          && request.resource.data.keys().hasAll(['senderId', 'text', 'timestamp', 'type', 'isRead'])
          && request.resource.data.senderId == request.auth.uid
          && request.resource.data.type in ['text', 'image', 'schedule', 'system'];
        allow update: if isAuthenticated()
          && request.auth.uid in get(/databases/$(database)/documents/chats/$(matchId)).data.participants
          && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['isRead']);
        allow delete: if false;
      }
    }

    // CONVERSATIONS (CURRENT APP CHAT FLOW)
    match /conversations/{conversationId} {
      allow read: if isAuthenticated()
        && request.auth.uid in resource.data.userIds;
      allow create: if isAuthenticated()
        && request.resource.data.keys().hasAll(['userIds', 'createdAt'])
        && request.auth.uid in request.resource.data.userIds
        && request.resource.data.userIds.size() == 2;
      allow update: if isAuthenticated()
        && request.auth.uid in resource.data.userIds
        && request.resource.data.userIds == resource.data.userIds
        && request.resource.data.createdAt == resource.data.createdAt;
      allow delete: if false;

      match /messages/{messageId} {
        allow read: if isAuthenticated()
          && request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.userIds;
        allow create: if isAuthenticated()
          && request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.userIds
          && request.resource.data.keys().hasAll(['conversationId', 'senderId', 'text', 'createdAt'])
          && request.resource.data.conversationId == conversationId
          && request.resource.data.senderId == request.auth.uid;
        allow update: if false;
        allow delete: if false;
      }
    }

    // SHIFTS (CURRENT APP FLOW)
    match /shifts/{shiftId} {
      allow read: if isAuthenticated() && request.auth.uid in resource.data.userIds;
      allow create: if isAuthenticated()
        && request.resource.data.keys().hasAll(['proposerId', 'accepterId', 'userIds', 'date', 'startTime', 'endTime', 'status', 'createdAt'])
        && request.resource.data.proposerId == request.auth.uid
        && request.resource.data.proposerId != request.resource.data.accepterId
        && request.auth.uid in request.resource.data.userIds
        && request.resource.data.accepterId in request.resource.data.userIds
        && request.resource.data.userIds.size() == 2
        && request.resource.data.status == 'proposed';
      allow update: if isAuthenticated()
        && request.auth.uid in resource.data.userIds
        && request.resource.data.userIds == resource.data.userIds
        && request.resource.data.proposerId == resource.data.proposerId
        && request.resource.data.accepterId == resource.data.accepterId
        && request.resource.data.createdAt == resource.data.createdAt
        && request.resource.data.status in ['proposed', 'accepted', 'rejected', 'completed', 'swap_proposed'];
      allow delete: if false;
    }

    // REVIEWS (CURRENT APP FLOW)
    match /reviews/{reviewId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated()
        && request.resource.data.keys().hasAll(['shiftId', 'revieweeId', 'reviewerId', 'rating', 'comment', 'tags', 'createdAt'])
        && request.resource.data.reviewerId == request.auth.uid
        && request.resource.data.revieweeId != request.auth.uid
        && request.resource.data.rating >= 1
        && request.resource.data.rating <= 5
        && exists(/databases/$(database)/documents/shifts/$(request.resource.data.shiftId))
        && request.auth.uid in get(/databases/$(database)/documents/shifts/$(request.resource.data.shiftId)).data.userIds
        && request.resource.data.revieweeId in get(/databases/$(database)/documents/shifts/$(request.resource.data.shiftId)).data.userIds;
      allow update: if false;
      allow delete: if false;
    }

    // NOTIFICATIONS
    match /notifications/{uid}/items/{notifId} {
      allow read: if isOwner(uid);
      allow create: if false;
      allow update: if isOwner(uid)
        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['isRead']);
      allow delete: if isOwner(uid);
    }

    // FCM TOKENS
    match /fcm_tokens/{uid} {
      allow read: if isOwner(uid);
      allow write: if isOwner(uid);
      allow delete: if isOwner(uid);
    }

    // REPORTS
    match /reports/{reportId} {
      allow read: if false;
      allow create: if isAuthenticated()
        && request.resource.data.keys().hasAll(['reporterId', 'reportedId', 'reason', 'timestamp'])
        && request.resource.data.reporterId == request.auth.uid;
      allow update: if false;
      allow delete: if false;
    }

    // BLOCKED USERS
    match /blocked_users/{uid}/list/{blockedUid} {
      allow read: if isOwner(uid);
      allow write: if isOwner(uid);
      allow delete: if isOwner(uid);
    }

    // APP CONFIG
    match /app_config/{document} {
      allow read: if isAuthenticated();
      allow write: if false;
    }

    // DEFAULT DENY
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

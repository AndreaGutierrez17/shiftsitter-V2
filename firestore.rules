rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // FUNCIONES DE AYUDA
    function isAuthenticated() {
      return request.auth != null;
    }
    function isOwner(uid) {
      return request.auth.uid == uid;
    }
    function isMatchParticipant(matchData) {
      return request.auth.uid == matchData.uid1 || request.auth.uid == matchData.uid2;
    }
    function hasRequiredUserFields() {
      return request.resource.data.keys().hasAll(['uid', 'email', 'createdAt', 'isActive']);
    }
    function hasRequiredMessageFields() {
      return request.resource.data.keys().hasAll(['senderId', 'text', 'timestamp', 'type', 'isRead']);
    }
    function isMessageSender() {
      return request.resource.data.senderId == request.auth.uid;
    }

    // USUARIOS
    match /users/{uid} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && isOwner(uid) && hasRequiredUserFields() && request.resource.data.uid == request.auth.uid;
      allow update: if isAuthenticated() && isOwner(uid) && request.resource.data.uid == resource.data.uid && request.resource.data.createdAt == resource.data.createdAt;
      allow delete: if false;

      match /profile/{document} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated() && isOwner(uid);
        allow delete: if false;
      }

      match /questionnaire/{questionId} {
        allow read: if isAuthenticated() && isOwner(uid);
        allow create: if isAuthenticated() && isOwner(uid);
        allow update: if isAuthenticated() && isOwner(uid);
        allow delete: if false;
      }

      match /kids/{kidId} {
        allow read: if isAuthenticated() && isOwner(uid);
        allow write: if isAuthenticated() && isOwner(uid);
        allow delete: if isAuthenticated() && isOwner(uid);
      }

      match /availability/{document} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated() && isOwner(uid);
        allow delete: if isAuthenticated() && isOwner(uid);
      }

      match /shiftHistory/{shiftId} {
        allow read: if isAuthenticated() && isOwner(uid);
        allow write: if false;
        allow delete: if false;
      }

      match /settings/{document} {
        allow read: if isAuthenticated() && isOwner(uid);
        allow write: if isAuthenticated() && isOwner(uid);
        allow delete: if false;
      }
    }

    // SWIPES
    match /swipes/{uid}/decisions/{targetUid} {
      allow read: if isAuthenticated() && isOwner(uid);
      allow create: if isAuthenticated() && isOwner(uid) && request.resource.data.keys().hasAll(['action', 'timestamp']) && request.resource.data.action in ['like', 'dislike', 'superlike'];
      allow update: if false;
      allow delete: if false;
    }

    // MATCHES
    match /matches/{matchId} {
      allow read: if isAuthenticated() && isMatchParticipant(resource.data);
      allow create: if false;
      allow update: if isAuthenticated() && isMatchParticipant(resource.data) && request.resource.data.uid1 == resource.data.uid1 && request.resource.data.uid2 == resource.data.uid2;
      allow delete: if false;

      match /shifts/{shiftId} {
        allow read: if isAuthenticated() && isMatchParticipant(get(/databases/$(database)/documents/matches/$(matchId)).data);
        allow create: if isAuthenticated() && isMatchParticipant(get(/databases/$(database)/documents/matches/$(matchId)).data) && request.resource.data.keys().hasAll(['date', 'startTime', 'endTime', 'caregiver', 'worker', 'status']) && request.resource.data.status == 'pending';
        allow update: if isAuthenticated() && isMatchParticipant(get(/databases/$(database)/documents/matches/$(matchId)).data) && request.resource.data.status in ['pending', 'confirmed', 'completed', 'cancelled'];
        allow delete: if false;
      }

      match /calendar/{document} {
        allow read: if isAuthenticated() && isMatchParticipant(get(/databases/$(database)/documents/matches/$(matchId)).data);
        allow write: if isAuthenticated() && isMatchParticipant(get(/databases/$(database)/documents/matches/$(matchId)).data);
      }
    }

    // CHATS
    match /chats/{matchId} {
      allow read: if isAuthenticated() && isMatchParticipant(get(/databases/$(database)/documents/matches/$(matchId)).data);
      allow create: if false;
      allow update: if isAuthenticated() && isMatchParticipant(get(/databases/$(database)/documents/matches/$(matchId)).data);
      allow delete: if false;

      match /messages/{messageId} {
        allow read: if isAuthenticated() && isMatchParticipant(get(/databases/$(database)/documents/matches/$(matchId)).data);
        allow create: if isAuthenticated() && isMatchParticipant(get(/databases/$(database)/documents/matches/$(matchId)).data) && hasRequiredMessageFields() && isMessageSender() && request.resource.data.type in ['text', 'image', 'schedule', 'system'];
        allow update: if isAuthenticated() && isMatchParticipant(get(/databases/$(database)/documents/matches/$(matchId)).data) && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['isRead']);
        allow delete: if false;
      }
    }

    // REVIEWS
    match /reviews/{reviewId} {
      allow read: if isAuthenticated() && (resource.data.receiverId == request.auth.uid || resource.data.senderId == request.auth.uid);
      allow create: if isAuthenticated() && request.resource.data.senderId == request.auth.uid && request.resource.data.keys().hasAll(['senderId', 'receiverId', 'matchId', 'rating', 'timestamp']) && request.resource.data.rating >= 1 && request.resource.data.rating <= 5;
      allow update: if false;
      allow delete: if false;
    }

    // NOTIFICACIONES
    match /notifications/{uid}/items/{notifId} {
      allow read: if isAuthenticated() && isOwner(uid);
      allow create: if false;
      allow update: if isAuthenticated() && isOwner(uid) && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['isRead']);
      allow delete: if isAuthenticated() && isOwner(uid);
    }

    // FCM TOKENS
    match /fcm_tokens/{uid} {
      allow read: if isAuthenticated() && isOwner(uid);
      allow write: if isAuthenticated() && isOwner(uid);
      allow delete: if isAuthenticated() && isOwner(uid);
    }

    // REPORTES
    match /reports/{reportId} {
      allow read: if false;
      allow create: if isAuthenticated() && request.resource.data.reporterId == request.auth.uid && request.resource.data.keys().hasAll(['reporterId', 'reportedId', 'reason', 'timestamp']);
      allow update: if false;
      allow delete: if false;
    }

    // USUARIOS BLOQUEADOS
    match /blocked_users/{uid}/list/{blockedUid} {
      allow read: if isAuthenticated() && isOwner(uid);
      allow write: if isAuthenticated() && isOwner(uid);
      allow delete: if isAuthenticated() && isOwner(uid);
    }

    // CONFIGURACION APP
    match /app_config/{document} {
      allow read: if isAuthenticated();
      allow write: if false;
    }

    // CONVERSACIONES (para el chat uno-a-uno)
    match /conversations/{conversationId} {
      allow read: if isAuthenticated() && request.auth.uid in resource.data.userIds;
      allow create: if isAuthenticated() && request.auth.uid in request.resource.data.userIds;
      allow update: if isAuthenticated() && request.auth.uid in resource.data.userIds;
      allow delete: if false;

      match /messages/{messageId} {
        allow read: if isAuthenticated() && request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.userIds;
        allow create: if isAuthenticated() && request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.userIds && request.resource.data.senderId == request.auth.uid;
        allow update: if isAuthenticated() && request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.userIds;
        allow delete: if false;
      }
    }

    // REGLA GLOBAL: deniega todo lo no especificado
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
